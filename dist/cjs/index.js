"use strict";var e=require("node:fs");require("reflect-metadata");var t=require("node:path"),s=require("node:url"),n=require("fast-glob"),i=require("express"),r=require("inversify"),o=require("helmet"),a=require("morgan"),l=require("@godaddy/terminus"),c=require("winston"),h=require("winston-daily-rotate-file"),u=require("routing-controllers"),d=require("typeorm"),p=require("ioredis"),g=require("express-session");const f="development"===(process.env.NODE_ENV||"development")?".env.development":".env.production";function w(e,t){return function(s,n){t(s,n,e)}}function y(e,t,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}function m(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&"[object Object]"===Object.prototype.toString.call(e)}function S(e,...t){if(!t.length)return e;const s={...e};for(const n of t)for(const t in n)m(n[t])&&t in e?s[t]=S(e[t],n[t]):s[t]=n[t];return s}function v(e){return!e||("string"==typeof e||Array.isArray(e)||"object"==typeof e&&"length"in e&&"number"==typeof e.length?0===e.length:e instanceof Map||e instanceof Set?0===e.size:"[object Object]"===Object.prototype.toString.call(e)&&0===Object.keys(e).length)}var b,E;e.existsSync(f)&&process.loadEnvFile(f),"function"==typeof SuppressedError&&SuppressedError;class T{constructor(){b.set(this,process.env.CONFIG_PATH||"./app.config.{ts,js,json}"),E.set(this,{public_path:"public",port:parseInt(process.env.PORT||"3000"),node_env:process.env.NODE_ENV||"development",is_dev:"development"===process.env.NODE_ENV,api_prefix:process.env.API_PREFIX||"",db:{enable:!1,client:{type:"mysql",host:process.env.DB_HOST||"localhost",port:parseInt(process.env.DB_PORT||"3306"),username:process.env.DB_USER||"root",password:process.env.DB_PASSWORD||"",database:process.env.DB_NAME||"",entities:[t.resolve("src/models/**/*{.ts,.js}")],migrations:[t.resolve("src/migrations/**/*{.ts,.js}")],poolSize:parseInt(process.env.DB_POOL_SIZE||"10"),synchronize:!1,logging:"development"===process.env.NODE_ENV}},redis:{enable:!1,client:{name:process.env.REDIS_MASTER_NAME||"mymaster",password:process.env.REDIS_PASSWORD||"",db:parseInt(process.env.REDIS_DB||"0"),lazyConnect:!0,sentinels:[{host:process.env.REDIS_SENTINEL_HOST||"localhost",port:parseInt(process.env.REDIS_SENTINEL_PORT||"26379")}]}},session:{enable:!0,prefix:process.env.SESSION_PREFIX||"session:",type:"memory",client:{secret:process.env.SESSION_SECRET||"session",resave:!1,saveUninitialized:!1,cookie:{secure:"production"===process.env.NODE_ENV,httpOnly:!0,maxAge:36e5}}},router:{cors:{origin:process.env.CORS_ORIGIN||"*",methods:process.env.CORS_METHODS||"GET,POST,PUT,DELETE,OPTIONS",credentials:!1},routePrefix:process.env.API_PREFIX||"",controllers:[t.resolve("src/controllers/**/*{.ts,.js}")],middlewares:[t.resolve("src/middlewares/**/*{.ts,.js}")],interceptors:[t.resolve("src/interceptors/**/*{.ts,.js}")]},https:{enable:!1,options:{port:parseInt(process.env.HTTPS_PORT||"443"),key:t.resolve(process.env.HTTPS_KEY||"key.pem"),cert:t.resolve(process.env.HTTPS_CERT||"cert.pem")}}})}async loadConfig(e){const t=await n(e||y(this,b,"f"),{onlyFiles:!0,ignore:["**/node_modules/**","**/dist/**"],absolute:!0});return v(t)||await this.setConfig(t[0]),y(this,E,"f")}async setConfig(e){try{const t=await this.resolve(e);!function(e,t,s,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===n?i.call(e,s):i?i.value=s:t.set(e,s)}(this,E,S(y(this,E,"f"),t),"f")}catch(t){throw console.error(`Error loading config file ${e}:`,t),t}}async resolve(e){if("undefined"==typeof require){const t=s.pathToFileURL(e).toString();let n=await import(t);return n=n?.default?.__esModule?n.default:n,n?.default||n}{const t=require(e);return t?.__esModule&&t.default?t.default:t}}get config(){return y(this,E,"f")}}b=new WeakMap,E=new WeakMap;const R={App:Symbol.for("App"),Config:Symbol.for("Config"),DataSource:Symbol.for("DataSource"),Redis:Symbol.for("Redis"),Logger:Symbol.for("Logger"),GracefulExit:Symbol.for("GracefulExit"),CreateSession:Symbol.for("CreateSession"),CreateServer:Symbol.for("CreateServer"),ClientIp:Symbol.for("ClientIp"),IocAdapter:Symbol.for("IocAdapter"),GlobalMiddlewares:Symbol.for("GlobalMiddlewares")};let C=class{constructor(e,t,s,n,r,o,a,l){this.config=e,this.logger=t,this.createSession=s,this.serverFactory=n,this.gracefulExit=r,this.globalMiddlewares=o,this.dataSource=a,this.redis=l,this.app=i(),this.server=null,this.globalMiddlewares.init(this.app)}async bootstrap(e){if(this.server)return this.server;const{config:t,logger:s,dataSource:n,redis:i}=this;try{await this.initialize();const r=await this.serverFactory(this.app);return this.server=await r.bootstrap(e||t.port),this.gracefulExit.register(this.server).setHealthCheck({"/health":async()=>({timestamp:(new Date).toISOString(),db:n?.isInitialized?"connected":"disconnected",redis:i?.status})}),s.info(`üöÄ Server running on http://localhost:${e||t.port}`),this.server}catch(e){throw s.error("‚ùå Failed to start server:",e),e}}use(...e){this.globalMiddlewares.register(...e)}async initialize(){try{await Promise.all([this.initDatabase(),this.initRedis(),this.cinfigGlobalMiddlewares()]),await this.configSession()}catch(e){throw this.logger.error("‚ùå Failed to initialize",e),e}}async initDatabase(){const{config:e,dataSource:t,logger:s,gracefulExit:n}=this;try{if(!t||!1===e.db.enable||t.isInitialized)return;await t.initialize(),s.info("‚úÖ Database connected"),n.addCleanupTask(async()=>{await t.destroy(),s.info("‚úÖ Database connection closed")})}catch(e){throw s.error("‚ùå Failed to connect to database",e),e}}async initRedis(){const{config:e,redis:t,logger:s,gracefulExit:n}=this;try{if(!t||!1===e.redis.enable)return;if("wait"!==t.status)return;await t.connect(),s.info("‚úÖ Redis connected"),n.addCleanupTask(async()=>{await t.quit(),s.info("‚úÖ Redis connection closed")})}catch(e){throw s.error("‚ùå Failed to connect to Redis",e),e}}async configSession(){const{createSession:e,config:t,logger:s,globalMiddlewares:n}=this;try{const{enable:i,type:r,prefix:o}=t.session;if(!1===i)return;if("redis"===r){if(!this.redis)throw new Error("Redis is required");e.setRedis(o,this.redis)}const a=e.getHandler();n.register(a),s.info(`‚úÖ Session set with ${r} store`)}catch(e){throw s.error("‚ùå Failed to config session:",e),e}}async cinfigGlobalMiddlewares(){this.globalMiddlewares.register(i.urlencoded({extended:!0}),o(),a("dev"))}};C=function(e,t,s,n){var i,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(r<3?i(o):r>3?i(t,s,o):i(t,s))||o);return r>3&&o&&Object.defineProperty(t,s,o),o}([r.injectable("Singleton"),w(0,r.inject(R.Config)),w(1,r.inject(R.Logger)),w(2,r.inject(R.CreateSession)),w(3,r.inject(R.CreateServer)),w(4,r.inject(R.GracefulExit)),w(5,r.inject(R.GlobalMiddlewares)),w(6,r.inject(R.DataSource)),w(7,r.inject(R.Redis)),function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:paramtypes",[Object,Function,Object,Function,Object,Object,Function,Function])],C);class D{constructor(e){this.logger=e,this.isRegistered=!1,this.isShuttingDown=!1,this.cleanupTasks=new Set,this.healthCheck={},this.uncaughtException=async e=>{this.isShuttingDown||(this.isShuttingDown=!0,this.logger.error("‚ö†Ô∏è Uncaught Exception:",e),await this.cleanup())},this.unhandledRejection=async e=>{this.isShuttingDown||(this.isShuttingDown=!0,this.logger.error("‚ö†Ô∏è Unhandled Rejection:",e),await this.cleanup())}}register(e,t){if(this.isRegistered)return this;if(!e.listening)throw new Error("Server Not Listening");return this.isRegistered=!0,this.removeAllListener(),this.addCleanupTask(async()=>{this.logger.info("‚úÖ container disposed")}),this.setupProcessHandlers(),l.createTerminus(e,{logger:(e,t)=>{t&&this.logger.error(e,t),e&&this.logger.info(e)},timeout:t?.timeout||3e4,signals:t?.signals||["SIGINT","SIGTERM"],healthChecks:this.healthCheck,onSignal:async()=>{this.isShuttingDown||(this.isShuttingDown=!0,this.logger.info("üö¶ Received termination signal"),await this.cleanup())}}),this}addCleanupTask(...e){e.forEach(e=>this.cleanupTasks.add(e))}setHealthCheck(e){this.healthCheck=e}async cleanup(){0!==this.cleanupTasks.size&&(await Promise.all([...this.cleanupTasks].map(e=>e())),this.cleanupTasks.clear(),this.logger.info("‚úÖ All resources closed").end())}setupProcessHandlers(){process.on("uncaughtException",this.uncaughtException),process.on("unhandledRejection",this.unhandledRejection)}removeAllListener(){["SIGINT","SIGTERM","uncaughtException","unhandledRejection"].forEach(e=>{process.listeners(e).forEach(t=>{t.name,process.removeListener(e,t)})})}}class x{constructor(e){this.container=e}get(e,t){const s=new r.Container({parent:this.container});return s.bind(R.ClientIp).toConstantValue(t?.context.ip),s.get(e)}}class j{constructor(){this.anonymous="<anonymous>",this.app=null,this.middlewareList=new Map}init(e){return this.app||(this.app=e),this}register(...e){this.validate(e),this.addBatch(this.formatHandlers(...e))}validate(e){if(v(e))throw new Error("Middleware handlers cannot be empty");if(!this.app)throw new Error("GlobalMiddlewares must be initialized with an Express app instance")}formatHandlers(...e){return e.map(e=>this.isIHandler(e)?e:{name:e.name||this.anonymous,handle:e})}isIHandler(e){return!(!e||"object"!=typeof e)&&("name"in e&&"handle"in e)}exists(e){return e.name!==this.anonymous&&(!(!this.middlewareList.has(e.name)&&!this.middlewareList.has(e.handle.name))&&e.name)}addBatch(e){const t=new Set,s=e.filter(e=>{const s=this.exists(e);return s?t.add(s):e.name===this.anonymous?this.setAnonymous(e.handle):this.middlewareList.set(e.name,e.handle),!s});if(t.size>0)throw new Error(`[${[...t].join(", ")}] middleware already registered`);s.length>0&&this.app.use(s.map(e=>e.handle))}setAnonymous(e){const t=this.middlewareList.get(this.anonymous);Array.isArray(t)?t.push(e):this.middlewareList.set(this.anonymous,[e])}get routers(){return this.middlewareList}}const I="development"===process.env.NODE_ENV,O=I?"debug":"info",A=c.createLogger({level:O,format:c.format.combine(c.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),c.format.errors({stack:!0}),c.format.json(),c.format.printf(({timestamp:e,level:t,message:s,stack:n})=>{const i=t.toUpperCase();return n?`${e} [${i}] ${s}\n${n}`:`${e} [${i}] ${s}`})),transports:[new c.transports.Console({format:c.format.combine(c.format.colorize({all:!0}))}),new h({filename:"logs/app-%DATE%.log",datePattern:"YYYY-MM-DD",zippedArchive:!0,maxSize:"20m",maxFiles:I?"7d":"30d"})]});class _{constructor(e,t,s){this.app=s,this.server=null,this.pending=null,u.useContainer(t),this.app=u.useExpressServer(s,e)}async bootstrap(e){return this.pending||(this.pending=new Promise((t,s)=>{if(this.server?.listening)throw new Error("Server already running");this.server=this.app.listen(e,e=>{e?s(e):t(this.server),this.pending=null})})),this.pending}async close(){if(this.pending&&await this.pending,this.server?.listening)return new Promise((e,t)=>{this.server.close(s=>{s?t(s):(this.server=null,e())})})}}let P=null;let M=null;function L(e,t,s){if(s)return s(e,t);if(e)throw e;return t}class N extends g.Store{constructor(e){super(),this.prefix=null==e.prefix?"sess:":e.prefix,this.scanCount=e.scanCount||100,this.serializer=e.serializer||JSON,this.ttl=e.ttl||86400,this.disableTTL=e.disableTTL||!1,this.disableTouch=e.disableTouch||!1,this.client=e.client}async get(e,t){const s=this.prefix+e;try{const e=await this.client.get(s);return L(null,e?await this.serializer.parse(e):null,t)}catch(e){return L(e,null,t)}}async set(e,t,s){const n=this.prefix+e,i=this.getTTL(t);try{if(i>0){const e=this.serializer.stringify(t);return this.disableTTL?await this.client.set(n,e):await this.client.setex(n,i,e),L(null,null,s)}return this.destroy(e,s)}catch(e){return L(e,null,s)}}async touch(e,t,s){const n=this.prefix+e;if(this.disableTouch||this.disableTTL)return L(null,null,s);try{return await this.client.expire(n,this.getTTL(t)),L(null,null,s)}catch(e){return L(e,null,s)}}async destroy(e,t){const s=this.prefix+e;try{return await this.client.del(s),L(null,null,t)}catch(e){return L(e,null,t)}}async clear(e){try{const t=await this.getAllKeys();return t.length?(await this.client.del(t),L(null,null,e)):L(null,null,e)}catch(t){return L(t,null,e)}}async length(e){try{return L(null,(await this.getAllKeys()).length,e)}catch(t){return L(t,null,e)}}async ids(e){const t=this.prefix.length;try{return L(null,(await this.getAllKeys()).map(e=>e.substring(t)),e)}catch(t){return L(t,null,e)}}async all(e){const t=this.prefix.length;try{const s=await this.getAllKeys();if(0===s.length)return L(null,[],e);const n=await this.client.mget(s);return L(null,n.reduce((e,n,i)=>{if(!n)return e;const r=this.serializer.parse(n);return r.id=s[i].substring(t),e.push(r),e},[]),e)}catch(t){return L(t,null,e)}}getTTL(e){if("function"==typeof this.ttl)return this.ttl(e);let t;if(e?.cookie?.expires){const s=Number(new Date(e.cookie.expires))-Date.now();t=Math.ceil(s/1e3)}else t=this.ttl;return t}async getAllKeys(){const e=this.prefix+"*",t=new Set;let s="0";do{const[n,i]=await this.client.scan(s,"MATCH",e,"COUNT",this.scanCount);s=n,i.forEach(e=>t.add(e))}while("0"!==s);return t.size>0?Array.from(t):[]}}class k{constructor(e){this.handler=null,this.config={secret:"session",resave:!1,saveUninitialized:!1},this.config=Object.assign({},this.config,e)}setRedis(e,t){if(!t)throw new Error("Redis instance is required");this.config.store=this.createRedisStore(e,t)}createRedisStore(e,t){return new N({client:t,prefix:e})}getHandler(){return this.handler??(this.handler=g(this.config)),this.handler}}class z{static register(){this.container.bind(R.Config).toDynamicValue(async()=>await(new T).loadConfig()).inSingletonScope(),this.container.bind(R.Logger).toConstantValue(A),this.container.bind(R.IocAdapter).toConstantValue(new x(this.container)),this.container.bind(R.DataSource).toResolvedValue(e=>{const{db:t}=e;return(e=>{const{enable:t,client:s}=e;if(t)return P||(P=new d.DataSource(s),P)})(t)},[R.Config]).inSingletonScope(),this.container.bind(R.Redis).toResolvedValue(e=>{const{redis:t}=e;return(e=>{const{enable:t,client:s}=e;if(t)return M||(M=new p.Redis(s),M)})(t)},[R.Config]).inSingletonScope(),this.container.bind(R.CreateSession).toResolvedValue(e=>{const{session:t}=e;return new k(t.client)},[R.Config]).inSingletonScope(),this.container.bind(R.CreateServer).toProvider(e=>{let t;const s=e.get(R.IocAdapter);return async n=>{const{router:i}=await e.getAsync(R.Config);return t||(t=new _(i,s,n)),t}}),this.container.bind(R.GracefulExit).toResolvedValue(e=>new D(e),[R.Logger]).inSingletonScope(),this.container.bind(R.GlobalMiddlewares).to(j).inSingletonScope(),this.container.bind(R.App).to(C)}static async getApp(){return await this.container.getAsync(R.App)}}z.container=new r.Container,z.register();exports.defineConfig=function(e){return e},exports.ready=()=>z.getApp();
//# sourceMappingURL=index.js.map
